name: Discord Notification on Commit

on:
  push:
    branches:
      - main  # Replace 'main' with the name of your base branch

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          submodules: recursive
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false
          fetch-depth: 0
          node-version: 16  # Set the Node.js version here

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16  # Set the Node.js version here

      - name: Install dependencies
        run: npm install discord.js

      - name: Send Discord Notification on Commit
        run: |
          node - <<EOF
            const { WebhookClient, MessageEmbed } = require('discord.js');

            const webhook = new WebhookClient({
              url: process.env.DISCORD_WEBHOOK_URL,
            });

            const commit = process.env.GITHUB_SHA.substring(0, 7);
            const repoName = process.env.GITHUB_REPOSITORY;
            const branchName = process.env.GITHUB_REF.replace('refs/heads/', '');

            const embed = new MessageEmbed()
              .setColor('#0099ff')
              .setTitle('New Commit')
              .setDescription(`A new commit has been made to the branch ${branchName} in ${repoName}.`)
              .addField('Commit', commit, true)
              .setTimestamp();

            webhook.send({ embeds: [embed] });
          EOF
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
