name: Discord Notification on Pull Request

on:
  pull_request:
    types:
      - opened  # You can specify other relevant events as needed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16  # Set the Node.js version here to Node.js 16

      - name: Install dependencies
        run: npm install discord.js

      - name: Send Discord Notification on Pull Request
        run: |
          const { WebhookClient, MessageEmbed } = require('discord.js');

          const webhook = new WebhookClient({
            url: process.env.DISCORD_WEBHOOK_URL,
          });

          const mention = process.env.DISCORD_MENTION || '';
          const pr = process.env.GITHUB_EVENT_PATH;

          try {
            const prData = require(pr);

            if (prData && prData.pull_request && prData.pull_request.user && prData.pull_request.user.login) {
              const embed = new MessageEmbed()
                .setColor('#0099ff')
                .setTitle('New Pull Request Created')
                .setDescription(`A new pull request has been created by ${prData.pull_request.user.login}`)
                .addField('Title', prData.pull_request.title, true)
                .addField('Repository', prData.repository.full_name, true)
                .addField('Branch', prData.pull_request.head.ref, true)
                .addField('Reviewers', mention, true)
                .setTimestamp();

              webhook.send({ embeds: [embed] });
            } else {
              console.error('Error: Missing or invalid data in prData');
            }
          } catch (error) {
            console.error('Error:', error);
          }
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
